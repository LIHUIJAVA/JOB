<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.px.mis.purc.dao.PursOrdrDao">
	<!-- 点击采购订单页面，点击【删除】按钮执行的Sql -->
	<delete id="deletePursOrdrByPursOrdrId" parameterType="String">
		delete
		po,pos from purs_ordr as po inner JOIN purs_ordr_sub as pos on
		po.purs_ordr_id = pos.purs_ordr_id
		where po.purs_ordr_id =
		#{pursOrdrId}
	</delete>
	<!-- 新增采购订单主表信息 -->
	<insert id="insertPursOrdr" parameterType="PursOrdr">
		insert into purs_ordr
		(purs_ordr_id, purs_ordr_dt, purs_typ_id,
		provr_id, acc_num,
		user_name,dept_id,form_typ_encd,
		provr_ordr_num, is_nt_chk,setup_pers,
		setup_tm, memo)
		values (#{pursOrdrId}, #{pursOrdrDt}, #{pursTypId},
		#{provrId}, #{accNum}, #{userName},#{deptId},"001",
		#{provrOrdrNum}, 0,
		#{setupPers},now(),#{memo})
	</insert>
	<!-- 删除时，备份删除订单到purs_ordr_dl表 -->
	<insert id="insertPursOrdrDl" parameterType="list">
		insert into
		purs_ordr_dl
		select * from purs_ordr as po where
		po.purs_ordr_id in
		<foreach collection="list" item="purs_ordr_id" open="("
			separator="," close=")">
			#{purs_ordr_id}
		</foreach>
	</insert>
	<!-- 修改采购主表信息 -->
	<update id="updatePursOrdrByPursOrdrId" parameterType="PursOrdr">
		update purs_ordr
		<set>
			<if test="userName != null">
				user_name = #{userName},
			</if>
			<if test="pursOrdrDt != null">
				purs_ordr_dt = #{pursOrdrDt},
			</if>
			<if test="pursTypId != null">
				purs_typ_id = #{pursTypId},
			</if>
			<if test="provrId != null">
				provr_id = #{provrId},
			</if>
			<if test="accNum != null">
				acc_num = #{accNum},
			</if>
			<if test="deptId != null">
				dept_id = #{deptId},
			</if>
			<if test="provrOrdrNum != null">
				provr_ordr_num = #{provrOrdrNum},
			</if>
			<if test="mdfr != null">
				mdfr = #{mdfr},
			</if>
			<if test="memo != null">
				memo = #{memo},
			</if>
			modi_tm = now()
		</set>
		where purs_ordr_id = #{pursOrdrId}
	</update>

	<!-- 按照编号查询采购订单主表 -->
	<sql id="Base_Column_List">
		po.*,pos.*,pos.memo as memos,pt.purs_typ_nm,
		mu.user_name,pd.provr_nm,mcd.measr_corp_nm,dd.dept_name,
		ind.invty_nm,ind.spc_model,ind.invty_cd,ind.bx_rule,ind.bao_zhi_qi_dt,ind.iptax_rate,ind.optax_rate,
		ind.highest_pur_price,ind.lo_sell_prc,ind.ref_cost,ind.ref_sell_prc,ind.ltst_cost,ind.crspd_bar_cd
		,ftt.form_typ_name
	</sql>
	<select id="selectPursOrdrByPursOrdrId" parameterType="String"
		resultMap="pursOrdrMap">
		select
		<include refid="Base_Column_List" />
		FROM purs_ordr as po LEFT JOIN purs_ordr_sub as pos ON po.purs_ordr_id= pos.purs_ordr_id
							LEFT JOIN purs_type as pt ON po.purs_typ_id = pt.purs_typ_id
							LEFT JOIN mis_user mu on po.acc_num=mu.acc_num
							LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
							LEFT JOIN provr_doc pd on po.provr_id=pd.provr_id
							LEFT JOIN invty_doc ind on pos.invty_encd=ind.invty_encd
							LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
							LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=po.form_typ_encd
		where po.purs_ordr_id =#{pursOrdrId}
	</select>

	<!-- 根据采购订单号查询采购订单信息，主要用于验证采购订单主表是否唯一 -->
	<select id="selectPursOrdrById" parameterType="String"
		resultType="PursOrdr">
		select * FROM purs_ordr where purs_ordr_id = #{pursOrdrId}
	</select>

	<!-- 条件查询采购订单主表信息 -->
	<select id="selectPursOrdrList" parameterType="Map"
		resultMap="pursOrdrMap">
		SELECT
		<include refid="Base_Column_List" />
		FROM purs_ordr as po LEFT JOIN purs_ordr_sub as pos ON po.purs_ordr_id= pos.purs_ordr_id
							LEFT JOIN purs_type as pt ON po.purs_typ_id =pt.purs_typ_id
							LEFT JOIN mis_user mu on po.acc_num=mu.acc_num
							LEFT JOIN provr_doc pd on po.provr_id=pd.provr_id
							LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
							LEFT JOIN invty_doc ind on pos.invty_encd=ind.invty_encd
							LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
							LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=po.form_typ_encd
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">		
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		ORDER BY po.purs_ordr_id DESC
		LIMIT #{index},#{num}
	</select>

	<select id="selectPursOrdrCount" parameterType="Map"
		resultType="Integer">
		SELECT count(po.purs_ordr_id)
		FROM purs_ordr as po LEFT JOIN
		purs_ordr_sub as pos ON po.purs_ordr_id =
		pos.purs_ordr_id
		LEFT JOIN
		purs_type as pt ON po.purs_typ_id = pt.purs_typ_id
		LEFT JOIN mis_user
		mu on po.acc_num=mu.acc_num
		LEFT JOIN provr_doc pd on
		po.provr_id=pd.provr_id
		LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
		LEFT JOIN invty_doc ind on pos.invty_encd=ind.invty_encd
		LEFT JOIN
		measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
		LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=po.form_typ_encd
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
							
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
	</select>



	<resultMap type="PursOrdr" id="pursOrdrMap"
		autoMapping="true">
		<id property="pursOrdrId" column="purs_ordr_id" />
		<collection property="pursOrdrSub" ofType="PursOrdrSub"
			autoMapping="true"><!-- 采购订单子表 -->
			<id property="ordrNum" column="ordr_num" />
			<result property="memo" column="memos" />
			<result property="baoZhiQi" column="bao_zhi_qi_dt" />
		</collection>
	</resultMap>

	<!-- 批量删除 -->
	<delete id="deletePursOrdrList" parameterType="java.util.List">
		delete po,pos
		from purs_ordr as po LEFT JOIN purs_ordr_sub as pos on
		po.purs_ordr_id =
		pos.purs_ordr_id
		where po.purs_ordr_id in
		<foreach item="pursOrdrId" collection="list" open="("
			close=")" separator=",">
			#{pursOrdrId}
		</foreach>
	</delete>

	<!-- 审核时更新审核状态 -->
	<update id="updatePursOrdrIsNtChkList"
		parameterType="java.util.List">
		update purs_ordr
		<trim prefix="set" suffixOverrides=",">
			<trim prefix="is_nt_chk =case" suffix="end,">
				<foreach collection="list" item="item" index="index">
					when
					purs_ordr_id = #{item.pursOrdrId} then #{item.isNtChk}
				</foreach>
			</trim>
			<trim prefix="chkr =case" suffix="end,">
				<foreach collection="list" item="item" index="index">
					<if test="item.chkr != null and item.chkr!=''">
						when purs_ordr_id = #{item.pursOrdrId} then
						#{item.chkr}
					</if>
				</foreach>
			</trim>
			<trim prefix="chk_tm =case" suffix="end,">
				<foreach collection="list" item="item" index="index">
					when
					purs_ordr_id = #{item.pursOrdrId} then now()
				</foreach>
			</trim>
		</trim>
		where purs_ordr_id in
		<foreach collection="list" index="index" item="item"
			separator="," open="(" close=")">
			#{item.pursOrdrId}
		</foreach>
	</update>
	<!-- 单个修改审核状态 -->
	<update id="updatePursOrdrIsNtChk" parameterType="PursOrdr">
		update purs_ordr
		<set>
			<if test="isNtChk != null">
				is_nt_chk = #{isNtChk},
			</if>
			<if test="chkr != null">
				chkr = #{chkr},
			</if>
			<if test="chkTm != null || chkTm == null">
				chk_tm = now(),
			</if>
		</set>
		where purs_ordr_id=#{pursOrdrId}
		and is_nt_chk != #{isNtChk}
	</update>

	<!-- 打印输入输出采购订单信息 -->
	<select id="printingPursOrdrList" parameterType="Map"
		resultMap="pursOrdrOrderBy">
		SELECT
		<include refid="Base_Column_List" />
		FROM purs_ordr as po LEFT JOIN purs_ordr_sub as pos ON po.purs_ordr_id
		= pos.purs_ordr_id
		LEFT JOIN purs_type as pt ON po.purs_typ_id =
		pt.purs_typ_id
		LEFT JOIN mis_user mu on po.acc_num=mu.acc_num
		LEFT JOIN
		provr_doc pd on po.provr_id=pd.provr_id
		LEFT JOIN dept_doc dd on
		po.dept_id=dd.dept_id
		LEFT JOIN invty_doc ind on
		pos.invty_encd=ind.invty_encd
		LEFT JOIN measr_corp_doc mcd on
		ind.measr_corp_id=mcd.measr_corp_id
		LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=po.form_typ_encd
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
								
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		ORDER BY po.purs_ordr_id DESC
	</select>

	<!-- 查询审核状态 -->
	<select id="selectPursOrdrIsNtChk" parameterType="String"
		resultType="Integer">
		select is_nt_chk from purs_ordr where
		purs_ordr_id=#{pursOrdrId}
	</select>

	<!-- 查询采购订单明细账 date_format(po.purs_ordr_dt,'%Y-%c-%d' ) 查询采购订单明细 -->
	<select id="selectPursOrdrByInvtyEncds" parameterType="Map"
		resultType="Map">
		SELECT
		date_format(po.purs_ordr_dt,'%Y-%c-%d %T' ) pursOrdrDt
		,ind.invty_encd invtyEncd,ind.invty_nm
		invtyNm,ind.spc_model spcModel,
		ind.invty_cd invtyCd,ind.bx_rule bxRule,mcd.measr_corp_nm
		measrCorpNm,sum(no_tax_amt)/sum(qty) noTaxUprc,sum(no_tax_amt)
		noTaxAmt,
		sum(prc_tax_sum)/sum(qty) cntnTaxUprc,sum(prc_tax_sum)
		prcTaxSum,sum(qty) qty,sum(bx_qty)
		bxQty,tax_rate taxRate
		FROM purs_ordr
		as po LEFT JOIN purs_ordr_sub as pos ON po.purs_ordr_id =
		pos.purs_ordr_id
		LEFT JOIN invty_doc ind on
		pos.invty_encd=ind.invty_encd
		LEFT JOIN measr_corp_doc mcd on
		ind.measr_corp_id=mcd.measr_corp_id
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
								
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		GROUP BY ind.invty_encd,po.purs_ordr_id,po.purs_ordr_dt
		<if
			test="sort != null and sort != '' and sortOrder !=null and sortOrder != '' ">
			ORDER BY ${sort} ${sortOrder}
		</if>
		<if test="index != null and num !=null">
			LIMIT #{index},#{num}
		</if>
	</select>

	<select id="selectPursOrdrByInvtyEncdCounts" parameterType="Map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM
		(SELECT
		date_format(po.purs_ordr_dt,'%Y-%c-%d %T' )
		pursOrdrDt ,ind.invty_encd invtyEncd,ind.invty_nm
		invtyNm,ind.spc_model spcModel,
		ind.invty_cd invtyCd,ind.bx_rule
		bxRule,mcd.measr_corp_nm
		measrCorpNm,sum(no_tax_amt)/sum(qty)
		noTaxUprc,sum(no_tax_amt)
		noTaxAmt,
		sum(prc_tax_sum)/sum(qty)
		cntnTaxUprc,sum(prc_tax_sum) prcTaxSum,sum(qty) qty,sum(bx_qty)
		bxQty,tax_rate taxRate
		FROM purs_ordr as po LEFT JOIN purs_ordr_sub as
		pos ON po.purs_ordr_id =
		pos.purs_ordr_id
		LEFT JOIN invty_doc ind on
		pos.invty_encd=ind.invty_encd
		LEFT JOIN measr_corp_doc mcd on
		ind.measr_corp_id=mcd.measr_corp_id
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
								
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		GROUP BY ind.invty_encd,po.purs_ordr_id,po.purs_ordr_dt
		) AS A
	</select>

	<!-- 查询采购订单明细账 date_format(po.purs_ordr_dt,'%Y-%c-%d' ) 采购发票明细 -->
	<select id="selectPursOrdrByInvtyEncd" parameterType="Map"
		resultType="Map">
		SELECT
		po.purs_inv_num pursInvNum,date_format(po.bllg_dt,'%Y-%c-%d %T'
		) bllgDt
		,ind.invty_encd invtyEncd,ind.invty_nm invtyNm,
		ind.spc_model
		spcModel,ind.invty_cd invtyCd,ind.bx_rule bxRule,mcd.measr_corp_nm
		measrCorpNm,
		sum(no_tax_amt)/sum(qty) noTaxUprc,sum(no_tax_amt)
		noTaxAmt,sum(tax_amt) taxAmt,
		sum(prc_tax_sum)/sum(qty)
		cntnTaxUprc,sum(prc_tax_sum)
		prcTaxSum,sum(qty) qty,sum(bx_qty)
		bxQty,pos.tax_rate taxRate,
		pos.tax_amt taxAmt,po.provr_id
		provrId,pd.provr_nm provrNm
		FROM purs_comn_inv as po LEFT JOIN
		purs_comn_inv_sub as pos ON
		po.purs_inv_num = pos.purs_inv_num
		LEFT JOIN
		mis_user mu on po.acc_num=mu.acc_num
		LEFT JOIN provr_doc pd on
		po.provr_id=pd.provr_id
		LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
		LEFT JOIN invty_doc ind on pos.invty_encd=ind.invty_encd
		LEFT JOIN
		measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
		<where>
			<if test="pursInvNumList != null and pursInvNumList.size() > 0">
				AND po.purs_inv_num in
				<foreach item="pursInvNum" collection="pursInvNumListt"
					open="(" close=")" separator=",">
					#{pursInvNum}
				</foreach>
			</if>
			<if test="bllgDt1 != null and bllgDt1 != ''">
				AND po.bllg_dt &gt;= #{bllgDt1}
			</if>
			<if test="bllgDt2 != null and bllgDt2 != ''">
				AND po.bllg_dt &lt;= #{bllgDt2}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
								
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		GROUP BY po.purs_inv_num,po.bllg_dt,ind.invty_encd
		<if
			test="sort != null and sort != '' and sortOrder !=null and sortOrder != '' ">
			ORDER BY ${sort} ${sortOrder}
		</if>
		<if test="index != null and num !=null">
			LIMIT #{index},#{num}
		</if>
	</select>
	<!--采购明细表-导出 -->
	<select id="selectPursOrdrByInvtyEncdPrint" parameterType="Map"
		resultType="Map">
		SELECT
		po.purs_inv_num 发票编号,date_format(po.bllg_dt,'%Y-%c-%d %T'
		) 单据日期
		,ind.invty_encd 存货编码,ind.invty_nm 存货名称,
		ind.spc_model
		规格型号,ind.invty_cd 存货代码,ind.bx_rule 箱规,mcd.measr_corp_nm
		主计量单位,
		sum(no_tax_amt)/sum(qty) 无税单价,sum(no_tax_amt)
		无税金额,sum(tax_amt) 税额合计,
		sum(prc_tax_sum)/sum(qty)
		含税单价,sum(prc_tax_sum)
		价税合计,sum(qty) 数量,sum(bx_qty)
		箱数,pos.tax_rate 税率,
		pos.tax_amt 税额,po.provr_id
		供应商编码,pd.provr_nm 供应商
		FROM purs_comn_inv as po LEFT JOIN
		purs_comn_inv_sub as pos ON
		po.purs_inv_num = pos.purs_inv_num
		LEFT JOIN
		mis_user mu on po.acc_num=mu.acc_num
		LEFT JOIN provr_doc pd on
		po.provr_id=pd.provr_id
		LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
		LEFT JOIN invty_doc ind on pos.invty_encd=ind.invty_encd
		LEFT JOIN
		measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
		<where>
			<if test="pursInvNumList != null and pursInvNumList.size() > 0">
				AND po.purs_inv_num in
				<foreach item="pursInvNum" collection="pursInvNumListt"
					open="(" close=")" separator=",">
					#{pursInvNum}
				</foreach>
			</if>
			<if test="bllgDt1 != null and bllgDt1 != ''">
				AND po.bllg_dt &gt;= #{bllgDt1}
			</if>
			<if test="bllgDt2 != null and bllgDt2 != ''">
				AND po.bllg_dt &lt;= #{bllgDt2}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
								
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		GROUP BY po.purs_inv_num,po.bllg_dt,ind.invty_encd
		
	</select>
	<!--查询总计 -->
	<select id="selectPursOrdrByInvtyEncdSums" parameterType="Map"
		resultType="Map">
		SELECT
		sum(no_tax_amt) noTaxAmt,sum(tax_amt) taxAmt,
		sum(prc_tax_sum)
		prcTaxSum,sum(qty) qty,sum(bx_qty) bxQty,
		pos.tax_amt taxAmt
		FROM
		purs_comn_inv as po LEFT JOIN
		purs_comn_inv_sub as pos ON
		po.purs_inv_num = pos.purs_inv_num
		LEFT JOIN
		mis_user mu on
		po.acc_num=mu.acc_num
		LEFT JOIN provr_doc pd on
		po.provr_id=pd.provr_id
		LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
		LEFT JOIN invty_doc ind
		on pos.invty_encd=ind.invty_encd
		LEFT JOIN
		measr_corp_doc mcd on
		ind.measr_corp_id=mcd.measr_corp_id
		<where>
			<if test="pursInvNumList != null and pursInvNumList.size() > 0">
				AND po.purs_inv_num in
				<foreach item="pursInvNum" collection="pursInvNumListt"
					open="(" close=")" separator=",">
					#{pursInvNum}
				</foreach>
			</if>
			<if test="bllgDt1 != null and bllgDt1 != ''">
				AND po.bllg_dt &gt;= #{bllgDt1}
			</if>
			<if test="bllgDt2 != null and bllgDt2 != ''">
				AND po.bllg_dt &lt;= #{bllgDt2}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
							
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
	</select>

	<select id="selectPursOrdrByInvtyEncdCount" parameterType="Map"
		resultType="Integer">
		SELECT COUNT(*)
		FROM
		( SELECT
		po.purs_inv_num pursInvNum
		FROM
		purs_comn_inv as po LEFT JOIN purs_comn_inv_sub as pos ON
		po.purs_inv_num = pos.purs_inv_num
		LEFT JOIN mis_user mu on
		po.acc_num=mu.acc_num
		LEFT JOIN provr_doc pd on po.provr_id=pd.provr_id
		LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
		LEFT JOIN invty_doc ind
		on pos.invty_encd=ind.invty_encd
		LEFT JOIN measr_corp_doc mcd on
		ind.measr_corp_id=mcd.measr_corp_id
		<where>
			<if test="pursInvNumList != null and pursInvNumList.size() > 0">
				AND po.purs_inv_num in
				<foreach item="pursInvNum" collection="pursInvNumListt"
					open="(" close=")" separator=",">
					#{pursInvNum}
				</foreach>
			</if>
			<if test="bllgDt1 != null and bllgDt1 != ''">
				AND po.bllg_dt &gt;= #{bllgDt1}
			</if>
			<if test="bllgDt2 != null and bllgDt2 != ''">
				AND po.bllg_dt &lt;= #{bllgDt2}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
								
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		GROUP BY po.purs_inv_num,po.bllg_dt,ind.invty_encd) AS A
	</select>

	<!-- 导入时使用的新增采购订单主表功能 -->
	<insert id="insertPursOrdrUpload" parameterType="PursOrdr">
		insert into
		purs_ordr
		(purs_ordr_id, purs_ordr_dt, purs_typ_id,
		provr_id, acc_num,
		user_name,dept_id,
		provr_ordr_num, is_nt_chk,chkr,chk_tm,setup_pers,
		setup_tm, mdfr, modi_tm, memo,form_typ_encd)
		values
		<foreach collection="list" item="item" index="index" separator="," close=";">
		 (#{item.pursOrdrId},
		#{item.pursOrdrDt}, #{item.pursTypId},
		#{item.provrId}, #{item.accNum}, #{item.userName},
		#{item.deptId},
		#{item.provrOrdrNum}, #{item.isNtChk}, #{item.chkr},#{item.chkTm},
		#{item.setupPers},#{item.setupTm},#{item.mdfr},#{item.modiTm},#{item.memo},"001")
		</foreach>
	</insert>

	<!-- 到货单、付款申请单参照时条件查询采购订单主子表信息 -->
	<select id="selectPursOrdrLists" parameterType="Map"
		resultMap="pursOrdrMap">
		SELECT
		<include refid="Base_Column_List" />
		FROM purs_ordr as po JOIN purs_ordr_sub as pos ON po.purs_ordr_id =
		pos.purs_ordr_id
		LEFT JOIN purs_type as pt ON po.purs_typ_id =
		pt.purs_typ_id
		LEFT JOIN mis_user mu on po.acc_num=mu.acc_num
		LEFT JOIN
		provr_doc pd on po.provr_id=pd.provr_id
		LEFT JOIN dept_doc dd on
		po.dept_id=dd.dept_id
		LEFT JOIN invty_doc ind on
		pos.invty_encd=ind.invty_encd
		LEFT JOIN measr_corp_doc mcd on
		ind.measr_corp_id=mcd.measr_corp_id
		LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=po.form_typ_encd
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
								
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="unApplPayAmt != null and unApplPayAmt!= ''">
				AND pos.un_appl_pay_amt != 0
			</if>
			<if test="unToGdsQty != null and unToGdsQty!= ''">
				AND pos.un_to_gds_qty != 0
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		GROUP BY po.purs_ordr_id
		ORDER BY po.purs_ordr_id desc
	</select>

	<select id="selectPursOrdrCounts" parameterType="Map"
		resultType="Integer">
		SELECT count(DISTINCT(po.purs_ordr_id))
		FROM purs_ordr as po JOIN
		purs_ordr_sub as pos ON po.purs_ordr_id =pos.purs_ordr_id
		LEFT JOIN invty_doc ind on pos.invty_encd=ind.invty_encd
		
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
								
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="unApplPayAmt != null and unApplPayAmt!= ''">
				AND pos.un_appl_pay_amt != 0
			</if>
			<if test="unToGdsQty != null and unToGdsQty!= ''">
				AND pos.un_to_gds_qty != 0
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
	</select>

	<resultMap
		type="com.px.mis.purc.service.impl.PursOrdrServiceImpl$zizhu"
		id="pursOrdrOrderBy" autoMapping="true">
		<id property="ordrNum" column="ordr_num" />
		<result property="memos" column="memos" />
		<result property="baoZhiQi" column="bao_zhi_qi_dt" />
	</resultMap>
	
	<select id="selectPursOrdrListOrderBy" parameterType="Map"
		resultMap="pursOrdrOrderBy">
		SELECT
		<include refid="Base_Column_List" />
		FROM purs_ordr as po LEFT JOIN purs_ordr_sub as pos ON po.purs_ordr_id= pos.purs_ordr_id
		LEFT JOIN purs_type as pt ON po.purs_typ_id =pt.purs_typ_id
		LEFT JOIN mis_user mu on po.acc_num=mu.acc_num
		LEFT JOIN provr_doc pd on po.provr_id=pd.provr_id
		LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
		LEFT JOIN invty_doc ind on pos.invty_encd=ind.invty_encd
		LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
		LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=po.form_typ_encd
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
				
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if> 
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
		<if
			test="sort != null and sort != '' and sortOrder !=null and sortOrder != '' ">
			ORDER BY ${sort} ${sortOrder}
		</if>
		LIMIT #{index},#{num}
	</select>
	<!-- 这是查询条件总计,不分页 -->
	<select id="selectPursOrdrListSum" parameterType="Map"
		resultType="map">
		SELECT
		IFNULL(sum(pos.no_tax_amt),0.0) noTaxAmt,
		IFNULL(sum(pos.prc_tax_sum),0.0) prcTaxSum,
		IFNULL(sum(pos.tax_amt),0.0) taxAmt,
		IFNULL(sum(pos.qty),0.0) qty,
		IFNULL(sum(pos.bx_qty),0.0) bxQty
		FROM purs_ordr as po LEFT JOIN purs_ordr_sub as pos ON po.purs_ordr_id= pos.purs_ordr_id
							LEFT JOIN purs_type as pt ON po.purs_typ_id =pt.purs_typ_id
							LEFT JOIN mis_user mu on po.acc_num=mu.acc_num
							LEFT JOIN provr_doc pd on po.provr_id=pd.provr_id
							LEFT JOIN dept_doc dd on po.dept_id=dd.dept_id
							LEFT JOIN invty_doc ind on pos.invty_encd=ind.invty_encd
							LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
							LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=po.form_typ_encd
		<where>
			<if test="pursOrdrIdList != null and pursOrdrIdList.size() > 0">
				AND po.purs_ordr_id in
				<foreach item="pursOrdrId" collection="pursOrdrIdList"
					open="(" close=")" separator=",">
					#{pursOrdrId}
				</foreach>
			</if>
			<if test="pursOrdrDt1 != null and pursOrdrDt1 != ''">
				AND po.purs_ordr_dt &gt;= #{pursOrdrDt1}
			</if>
			<if test="pursOrdrDt2 != null and pursOrdrDt2 != ''">
				AND po.purs_ordr_dt &lt;= #{pursOrdrDt2}
			</if>
			<if test="isNtChk != null and isNtChk != ''">
				AND po.is_nt_chk=#{isNtChk}
			</if>
			<if test="provrIdList != null and provrIdList.size() > 0">
				AND po.provr_id in
				<foreach item="provrId" collection="provrIdList" open="("
					close=")" separator=",">
					#{provrId}
				</foreach>
			</if>
			<if test="invtyEncdList != null and invtyEncdList.size() > 0">
				AND pos.invty_encd in
				<foreach item="invtyEncd" collection="invtyEncdList"
					open="(" close=")" separator=",">
					#{invtyEncd}
				</foreach>
			</if>
			<if
				test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">		
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
			</if>
			<if test="invtyCdList != null and invtyCdList.size() > 0">
				AND ind.invty_cd in
				<foreach item="invtyCd" collection="invtyCdList" open="("
					close=")" separator=",">
					#{invtyCd}
				</foreach>
			</if>
			<if test="deptIdList != null and deptIdList.size() > 0">
				AND po.dept_id in
				<foreach item="deptId" collection="deptIdList" open="("
					close=")" separator=",">
					#{deptId}
				</foreach>
			</if>
			<if test="accNumList != null and accNumList.size() > 0">
				AND po.acc_num in
				<foreach item="accNum" collection="accNumList" open="("
					close=")" separator=",">
					#{accNum}
				</foreach>
			</if>
			<if
				test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
				AND po.provr_ordr_num in
				<foreach item="provrOrdrNum" collection="provrOrdrNumList"
					open="(" close=")" separator=",">
					#{provrOrdrNum}
				</foreach>
			</if>
			<if test="memo != null and memo != ''">
                <bind name="memo" value="'%'+ memo +'%'"/>
                AND po.memo like #{memo}
            </if>
		</where>
	</select>

</mapper>