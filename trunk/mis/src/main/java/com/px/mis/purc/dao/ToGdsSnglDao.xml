<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.px.mis.purc.dao.ToGdsSnglDao">
  <!-- 删除到货单 -->
  <delete id="deleteToGdsSnglByToGdsSnglId" parameterType="String">
    delete tgs,tgss from to_gds_sngl as tgs LEFT JOIN to_gds_sngl_Sub as tgss on tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
    where tgs.to_gds_sngl_id = #{toGdsSnglId} 
  </delete>
 <!--  新增到货单信息 -->
  <insert id="insertToGdsSngl" parameterType="ToGdsSngl">
    insert into to_gds_sngl (to_gds_sngl_id, to_gds_sngl_dt, purs_typ_id, 
      provr_id, acc_num, user_name, purs_ordr_id,dept_id,form_typ_encd,
      provr_ordr_num, is_nt_chk,setup_pers, 
      setup_tm, memo,deal_stat,is_nt_rtn_good,to_form_typ_encd)
    values (#{toGdsSnglId}, #{toGdsSnglDt}, #{pursTypId}, 
      #{provrId}, #{accNum}, #{userName}, #{pursOrdrId},
      #{deptId},#{formTypEncd},#{provrOrdrNum}, 0, #{setupPers}, 
      now(), #{memo} ,'已打开',#{isNtRtnGood},#{toFormTypEncd});
  </insert> 
 <!--  删除到货单时，备份到废弃表 -->
  <insert id="insertToGdsSnglDl" parameterType="list">
    insert into to_gds_sngl_dl
    select * from to_gds_sngl as tgs where tgs.to_gds_sngl_id in
    <foreach item="lists2" collection="list" open="(" separator="," close=")">
		#{lists2}
	</foreach>
  </insert> 
   <!--  导入使用的新增到货单功能 -->
  <insert id="insertToGdsSnglUpload" parameterType="ToGdsSngl">
    insert into to_gds_sngl (to_gds_sngl_id, to_gds_sngl_dt, purs_typ_id, 
      provr_id, acc_num, user_name, purs_ordr_id,
      provr_ordr_num, is_nt_chk,chkr,chk_tm,setup_pers, 
      setup_tm, mdfr,  modi_tm, memo,deal_stat,is_nt_rtn_good,dept_id,form_typ_encd,to_form_typ_encd)
    values
    <foreach collection="list" item="item" index="index" separator="," close=";">
     (#{item.toGdsSnglId}, #{item.toGdsSnglDt}, #{item.pursTypId}, 
      #{item.provrId}, #{item.accNum},#{item.userName},#{item.pursOrdrId}, #{item.provrOrdrNum}, 
      #{item.isNtChk}, #{item.chkr},#{item.chkTm},#{item.setupPers}, #{item.setupTm}, 
      #{item.mdfr}, #{item.modiTm}, #{item.memo}, #{item.dealStat}, #{item.isNtRtnGood},
      #{item.deptId},#{item.formTypEncd},#{item.toFormTypEncd})
     </foreach>
  </insert>
  
  <!--   修改到货单信息 -->
  <update id="updateToGdsSnglByToGdsSnglId" parameterType="ToGdsSngl">
    update to_gds_sngl
    <set>
      <if test="toGdsSnglDt != null">
        to_gds_sngl_dt = #{toGdsSnglDt},
      </if>
      <if test="pursTypId != null">
        purs_typ_id = #{pursTypId},
      </if>
      <if test="deptId != null">
        dept_id = #{deptId},
      </if>
      <if test="userName != null">
        user_name = #{userName},
      </if>
      <if test="pursOrdrId != null">
        purs_ordr_id = #{pursOrdrId},
      </if>
      <if test="provrId != null">
        provr_id = #{provrId},
      </if>
       <if test="dealStat != null">
        deal_stat = #{dealStat},
      </if>
      <if test="accNum != null">
        acc_num = #{accNum},
      </if>
      <if test="provrOrdrNum != null">
        provr_ordr_num = #{provrOrdrNum},
      </if>
      <if test="mdfr != null">
        mdfr = #{mdfr},
      </if>
      <if test="memo != null">
        memo = #{memo},
      </if>
       <if test="toFormTypEncd != null">
        to_form_typ_encd = #{toFormTypEncd},
      </if>
       modi_tm = now()
    </set>
    where to_gds_sngl_id = #{toGdsSnglId}
  </update>
  
  <sql id="Base_Column_List">
    tgs.*,tgss.*,tgss.memo as memos,pt.purs_typ_nm,mu.user_name,dd.dept_name,
    pd.provr_nm,mcd.measr_corp_id,mcd.measr_corp_nm,wd.whs_nm,ftt.form_typ_name,
    ind.invty_nm,ind.spc_model,ind.invty_cd,ind.bx_rule,ind.bao_zhi_qi_dt,ind.iptax_rate,ind.optax_rate,
    ind.highest_pur_price,ind.lo_sell_prc,ind.ref_cost,ind.ref_sell_prc,ind.ltst_cost,ind.crspd_bar_cd
  </sql>
  
  <!--   按照编号查询到货单信息 -->
  <select id="selectToGdsSnglByToGdsSnglId" parameterType="String" resultMap="toGdsSnglMap">
    select 
    <include refid="Base_Column_List" />
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
                            LEFT JOIN purs_type as pt ON tgs.purs_typ_id = pt.purs_typ_id 
	                    	LEFT JOIN mis_user mu on tgs.acc_num=mu.acc_num 
	                     	LEFT JOIN provr_doc pd on tgs.provr_id=pd.provr_id
	                     	LEFT JOIN dept_doc dd on tgs.dept_id=dd.dept_id
	                     	LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
	                     	LEFT JOIN invty_doc ind on tgss.invty_encd=ind.invty_encd
	                     	LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
	                     	LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=tgs.form_typ_encd
    where tgs.to_gds_sngl_id = #{toGdsSnglId}
  </select>
  
  <!-- 在到货单列表中查询所有到货单信息 -->
  <select id="selectToGdsSnglList" parameterType="Map" resultMap="toGdsSnglMap">
    SELECT <include refid="Base_Column_List" />  
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
                            LEFT JOIN purs_type as pt ON tgs.purs_typ_id = pt.purs_typ_id 
	                    	LEFT JOIN mis_user mu on tgs.acc_num=mu.acc_num 
	                     	LEFT JOIN provr_doc pd on tgs.provr_id=pd.provr_id
	                     	LEFT JOIN dept_doc dd on tgs.dept_id=dd.dept_id
	                     	LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
	                     	LEFT JOIN invty_doc ind on tgss.invty_encd=ind.invty_encd
	                     	LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
	                     	LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=tgs.form_typ_encd
  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
        <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">		
					<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
  	</where>
  	LIMIT #{index},#{num}
  </select>
  
  <select id="selectToGdsSnglCount" parameterType="Map" resultType="Integer">
	SELECT count(tgs.to_gds_sngl_id)
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
                            LEFT JOIN purs_type as pt ON tgs.purs_typ_id = pt.purs_typ_id 
	                    	LEFT JOIN mis_user mu on tgs.acc_num=mu.acc_num 
	                     	LEFT JOIN provr_doc pd on tgs.provr_id=pd.provr_id
	                     	LEFT JOIN dept_doc dd on tgs.dept_id=dd.dept_id
	                     	LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
	                     	LEFT JOIN invty_doc ind on tgss.invty_encd=ind.invty_encd
	                     	LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id  
	                     	LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=tgs.form_typ_encd	

  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
         <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
			<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
  	</where>
  </select>
  
 <resultMap type="ToGdsSngl" id="toGdsSnglMap" autoMapping="true">
		<id property="toGdsSnglId" column="to_gds_sngl_id" />
	    <collection property="toGdsSnglSub" ofType="ToGdsSnglSub" autoMapping="true">
		    <id property="ordrNum" column="ordr_num" /> 
		    <result property="memo" column="memos" /> 
	    </collection>
 </resultMap> 
 
  <!-- 到货单列表中批量删除 -->
  <delete id="deleteToGdsSnglList" parameterType="java.util.List">
	delete tgs,tgss 
	FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
    where tgs.to_gds_sngl_id in
	<foreach item="toGdsSnglId" collection="list" open="(" close=")" separator=",">
	     #{toGdsSnglId}
	</foreach>
  </delete>
  
  <!-- 审核时更新审核状态 -->
  <update id="updateToGdsSnglIsNtChkList" parameterType="java.util.List">
    update to_gds_sngl 
    <trim prefix="set" suffixOverrides=",">
         <trim prefix="is_nt_chk =case" suffix="end,">
             <foreach collection="list" item="item" index="index">                    
                  when to_gds_sngl_id = #{item.toGdsSnglId} then #{item.isNtChk}
             </foreach>
         </trim>
         <trim prefix="chkr =case" suffix="end,">
             <foreach collection="list" item="item" index="index">
                  <if test="item.chkr != null and item.chkr!=''">
                  when to_gds_sngl_id = #{item.toGdsSnglId} then #{item.chkr}
                  </if>
             </foreach>
        </trim>
        <trim prefix="chk_tm =case" suffix="end,">
             <foreach collection="list" item="item" index="index">                  
                  when to_gds_sngl_id = #{item.toGdsSnglId} then now()
             </foreach>
        </trim>
     </trim>
     where to_gds_sngl_id in
    <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
        #{item.toGdsSnglId}
    </foreach>
  </update>
  <!-- 审核时单个更新审核状态 -->
  <update id="updateToGdsSnglIsNtChk" parameterType="ToGdsSngl">
    update to_gds_sngl 
    <set>
	     <if test="isNtChk != null">
	        is_nt_chk = #{isNtChk},
	     </if>
	     <if test="chkr != null">
	       chkr = #{chkr},
	     </if>
	     <if test="chkTm != null || chkTm == null">
	       chk_tm = now(),
	     </if>
    </set>
     where to_gds_sngl_id=#{toGdsSnglId}
     and is_nt_chk != #{isNtChk}
  </update>
  
  <!-- 打印及输入输出时查询所有到货单信息 -->
  <select id="printingToGdsSnglList" parameterType="Map" resultMap="toGdsSnglOrderBy">
    SELECT <include refid="Base_Column_List" />  
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
                            LEFT JOIN purs_type as pt ON tgs.purs_typ_id = pt.purs_typ_id 
	                    	LEFT JOIN mis_user mu on tgs.acc_num=mu.acc_num 
	                     	LEFT JOIN provr_doc pd on tgs.provr_id=pd.provr_id
	                     	LEFT JOIN dept_doc dd on tgs.dept_id=dd.dept_id
	                     	LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
	                     	LEFT JOIN invty_doc ind on tgss.invty_encd=ind.invty_encd
	                     	LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
	                     	LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=tgs.form_typ_encd   
  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
        <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
			<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
  	</where>
  		ORDER BY 
  	<if test="sort != null and sort != '' and sortOrder !=null and sortOrder != '' ">
		${sort} ${sortOrder},
	</if> 
  		tgs.to_gds_sngl_id DESC
  </select>
  
  <!--  查询审核状态 -->
  <select id="selectToGdsSnglIsNtChk" parameterType="String" resultType="Integer">
    select is_nt_chk from to_gds_sngl where to_gds_sngl_id=#{toGdsSnglId}
  </select>
  
  <!--  根据采购订单查询到货单信息 -->
  <select id="selectToGdsSnglByPursOrdrId" parameterType="ToGdsSngl" resultType="ToGdsSngl">
    select * from to_gds_sngl where purs_ordr_id =#{pursOrdrId} 
  </select>
  
    <!--  根据到货单号查询到货单信息 -->
  <select id="selectToGdsSnglById" parameterType="String" resultType="ToGdsSngl">
    select * from to_gds_sngl where to_gds_sngl_id=#{toGdsSnglId}
  </select>
  
  
    <!-- 到货明细表 -->
  <select id="selectToGdsSnglByInvtyEncd" parameterType="Map" resultType="Map">
    SELECT 
        date_format(tgs.to_gds_sngl_dt,'%Y-%c-%d %T') toGdsSnglDt,ind.invty_encd invtyEncd,ind.invty_nm invtyNm,ind.spc_model spcModel,
        ind.invty_cd invtyCd,ind.bx_rule bxRule,mcd.measr_corp_nm measrCorpNm,tgss.whs_encd whsEncd,wd.whs_nm whsNm,tgss.bat_num batNum,
    	date_format(tgss.prdc_dt,'%Y-%c-%d %T') prdcDt,tgss.bao_zhi_qi baoZhiQi,date_format(tgss.invldtn_dt,'%Y-%c-%d %T') invldtnDt,
    	sum(no_tax_amt)/sum(qty) noTaxUprc,sum(no_tax_amt) noTaxAmt,sum(prc_tax_sum)/sum(qty) cntnTaxUprc,sum(prc_tax_sum) prcTaxSum,
    	sum(qty) qty,sum(bx_qty) bxQty,tax_rate taxRate
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub tgss on tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
               				LEFT JOIN invty_doc ind on tgss.invty_encd =ind.invty_encd
               				LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
               				LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
        <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
			<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
  	</where>
  	GROUP BY ind.invty_encd,tgss.whs_encd,tgss.bat_num,tgs.to_gds_sngl_id
  	ORDER BY 
  	<if test="sort != null and sort != '' and sortOrder !=null and sortOrder != '' ">
		${sort} ${sortOrder},
	</if> 
  		to_gds_sngl_dt DESC
  
  	<if test="index != null and num !=null">
  	LIMIT #{index},#{num}
  	</if>
  </select>
  
  <select id="selectToGdsSnglByInvtyEncdCount" parameterType="Map" resultType="Integer">
	SELECT count(*)
    FROM (SELECT 
        date_format(tgs.to_gds_sngl_dt,'%Y-%c-%d %T') toGdsSnglDt,ind.invty_encd invtyEncd,ind.invty_nm invtyNm,ind.spc_model spcModel,
        ind.invty_cd invtyCd,ind.bx_rule bxRule,mcd.measr_corp_nm measrCorpNm,tgss.whs_encd whsEncd,wd.whs_nm whsNm,tgss.bat_num batNum,
    	date_format(tgss.prdc_dt,'%Y-%c-%d %T') prdcDt,tgss.bao_zhi_qi baoZhiQi,date_format(tgss.invldtn_dt,'%Y-%c-%d %T') invldtnDt,
    	sum(no_tax_amt)/sum(qty) noTaxUprc,sum(no_tax_amt) noTaxAmt,sum(prc_tax_sum)/sum(qty) cntnTaxUprc,sum(prc_tax_sum) prcTaxSum,
    	sum(qty) qty,sum(bx_qty) bxQty,tax_rate taxRate
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub tgss on tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
               				LEFT JOIN invty_doc ind on tgss.invty_encd =ind.invty_encd
               				LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
               				LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd

  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
        <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
			<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
  	</where>
  	GROUP BY ind.invty_encd,tgss.whs_encd,tgss.bat_num,tgs.to_gds_sngl_id
  	) as A
  </select>
  
  <!--  查询退货状态 -->
  <select id="selectToGdsSnglIsNtRtnGood" parameterType="String" resultType="Integer">
    select is_nt_rtn_good from to_gds_sngl where to_gds_sngl_id=#{toGdsSnglId}
  </select>
  
    <!-- 采购入库单、到货拒收单参照时查询所有到货单主表信息 -->
  <select id="selectToGdsSnglLists" parameterType="Map" resultMap="toGdsSnglMap">
    SELECT <include refid="Base_Column_List" />  
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
                            LEFT JOIN purs_type as pt ON tgs.purs_typ_id = pt.purs_typ_id 
	                    	LEFT JOIN mis_user mu on tgs.acc_num=mu.acc_num 
	                     	LEFT JOIN provr_doc pd on tgs.provr_id=pd.provr_id
	                     	LEFT JOIN dept_doc dd on tgs.dept_id=dd.dept_id
	                     	LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
	                     	LEFT JOIN invty_doc ind on tgss.invty_encd=ind.invty_encd
	                     	LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
	                     	LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=tgs.form_typ_encd
  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
        <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
			<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="unIntoWhsQty!= null and unIntoWhsQty!= ''">
			AND tgss.un_into_whs_qty>0
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
		<if test="returnQty!= null and returnQty!= ''">
			AND tgss.return_qty>0
		</if>
			AND tgs.deal_stat='已打开'
  	</where>
  	GROUP BY tgs.to_gds_sngl_id
  	ORDER BY 
  	<if test="sort != null and sort != '' and sortOrder !=null and sortOrder != '' ">
		${sort} ${sortOrder},
	</if> 
	tgs.to_gds_sngl_id DESC
	
  	LIMIT #{index},#{num}
  </select>
  
  <select id="selectToGdsSnglCounts" parameterType="Map" resultType="Integer">
	SELECT count(DISTINCT(tgs.to_gds_sngl_id))
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
                            LEFT JOIN purs_type as pt ON tgs.purs_typ_id = pt.purs_typ_id 
	                    	LEFT JOIN mis_user mu on tgs.acc_num=mu.acc_num 
	                     	LEFT JOIN provr_doc pd on tgs.provr_id=pd.provr_id
	                     	LEFT JOIN dept_doc dd on tgs.dept_id=dd.dept_id
	                     	LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
	                     	LEFT JOIN invty_doc ind on tgss.invty_encd=ind.invty_encd
	                     	LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id  
	                     	LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=tgs.form_typ_encd	

  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
         <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
			<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="unIntoWhsQty!= null and unIntoWhsQty!= ''">
			AND tgss.un_into_whs_qty>0
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
		<if test="returnQty!= null and returnQty!= ''">
			AND tgss.return_qty>0
		</if>
			AND tgs.deal_stat='已打开'
  	</where>
  </select>
  
<select id="selectToGdsSnglListOrderBy" parameterType="Map" resultMap="toGdsSnglOrderBy">
    SELECT <include refid="Base_Column_List" />  
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
                            LEFT JOIN purs_type as pt ON tgs.purs_typ_id = pt.purs_typ_id 
	                    	LEFT JOIN mis_user mu on tgs.acc_num=mu.acc_num 
	                     	LEFT JOIN provr_doc pd on tgs.provr_id=pd.provr_id
	                     	LEFT JOIN dept_doc dd on tgs.dept_id=dd.dept_id
	                     	LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
	                     	LEFT JOIN invty_doc ind on tgss.invty_encd=ind.invty_encd
	                     	LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
	                     	LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=tgs.form_typ_encd
  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
        <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
			<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
  	</where>
  		
  	<if test="sort != null and sort != '' and sortOrder !=null and sortOrder != '' ">
		ORDER BY   ${sort} ${sortOrder} 
	</if> 
 		 
  	LIMIT #{index},#{num}
  </select>
  
 <resultMap type="com.px.mis.purc.service.impl.ToGdsSnglServiceImpl$zizhu" id="toGdsSnglOrderBy" autoMapping="true">
    		<id property="ordrNum" column="ordr_num" />
    		
  </resultMap>
  
  <select id="selectToGdsSnglListSums" parameterType="Map" resultType="map">
    SELECT 
    IFNULL(SUM(tgss.qty),0.0) qty,IFNULL(SUM(tgss.bx_qty),0.0) bxQty,
    IFNULL(SUM(tgss.no_tax_amt),0.0) noTaxAmt,
    IFNULL(SUM(tgss.prc_tax_sum),0.0) prcTaxSum,
    IFNULL(SUM(tgss.tax_amt),0.0) taxAmt
    FROM to_gds_sngl as tgs LEFT JOIN to_gds_sngl_sub as tgss ON tgs.to_gds_sngl_id=tgss.to_gds_sngl_id
                            LEFT JOIN purs_type as pt ON tgs.purs_typ_id = pt.purs_typ_id 
	                    	LEFT JOIN mis_user mu on tgs.acc_num=mu.acc_num 
	                     	LEFT JOIN provr_doc pd on tgs.provr_id=pd.provr_id
	                     	LEFT JOIN dept_doc dd on tgs.dept_id=dd.dept_id
	                     	LEFT JOIN whs_doc wd on tgss.whs_encd=wd.whs_encd
	                     	LEFT JOIN invty_doc ind on tgss.invty_encd=ind.invty_encd
	                     	LEFT JOIN measr_corp_doc mcd on ind.measr_corp_id=mcd.measr_corp_id
	                     	LEFT JOIN form_typ_tabs ftt on ftt.form_typ_encd=tgs.form_typ_encd
  	<where>
  		<if test="toGdsSnglIdList != null and toGdsSnglIdList.size() > 0">
            AND tgs.to_gds_sngl_id in
            <foreach item="toGdsSnglId" collection="toGdsSnglIdList" open="("
				 close=")" separator=",">
				 #{toGdsSnglId}
		    </foreach>
        </if>
        <if test="toGdsSnglDt1 != null and toGdsSnglDt1 != ''">
            AND tgs.to_gds_sngl_dt &gt;=#{toGdsSnglDt1}
        </if>
        <if test="toGdsSnglDt2 != null and toGdsSnglDt2 != ''">
            AND tgs.to_gds_sngl_dt &lt;=#{toGdsSnglDt2}
        </if>
        <if test="isNtRtnGood != null and isNtRtnGood != ''">
            AND tgs.is_nt_rtn_good=#{isNtRtnGood}
        </if>
        <if test="isNtChk != null and isNtChk != ''">
            AND tgs.is_nt_chk=#{isNtChk}
        </if>
       <if test="invtyEncdList != null and invtyEncdList.size() > 0">
            AND tgss.invty_encd in
            <foreach item="invtyEncd" collection="invtyEncdList" open="("
				 close=")" separator=",">
				 #{invtyEncd}
		    </foreach>
        </if>
        <if test="invtyClsEncdList != null and invtyClsEncdList.size() > 0">
			<bind name="bindInvtyClsEncd" value="invtyClsEncd +'%'"/>
					AND ind.invty_cls_encd  like #{bindInvtyClsEncd}
		</if>
		<if test="invtyCdList != null and invtyCdList.size() > 0">
			AND ind.invty_cd in
			<foreach item="invtyCd" collection="invtyCdList" open="("
				 close=")" separator=",">
				 #{invtyCd}
		    </foreach>
		</if>
        <if test="provrIdList != null and provrIdList.size() > 0">
            AND tgs.provr_id in
            <foreach item="provrId" collection="provrIdList" open="("
				 close=")" separator=",">
				 #{provrId}
		    </foreach>
        </if>
		<if test="deptIdList != null and deptIdList.size() > 0">
			AND tgs.dept_id in
			<foreach item="deptId" collection="deptIdList" open="("
				 close=")" separator=",">
				 #{deptId}
		    </foreach>
		</if>
        <if test="accNumList != null and accNumList.size() > 0">
			AND tgs.acc_num in 
			<foreach item="accNum" collection="accNumList" open="("
				 close=")" separator=",">
				 #{accNum}
		    </foreach>
		</if>
        <if test="provrOrdrNumList != null and provrOrdrNumList.size() > 0">
            AND tgs.provr_ordr_num in
            <foreach item="provrOrdrNum" collection="provrOrdrNumList" open="("
				 close=")" separator=",">
				 #{provrOrdrNum}
		    </foreach>
        </if>
        <if test="whsEncdList!= null and whsEncdList.size() > 0">
			AND tgss.whs_encd in
			<foreach item="whsEncdList" collection="whsEncdList" open="("
				 close=")" separator=",">
				 #{whsEncdList}
		    </foreach>
		</if>
		<if test="batNumList!= null and batNumList.size() > 0">
			AND tgss.bat_num in
			<foreach item="batNum" collection="batNumList" open="("
				 close=")" separator=",">
				 #{batNum}
		    </foreach>
		</if>
		<if test="intlBatList!= null and intlBatList.size() > 0">
			AND tgss.intl_bat in
			<foreach item="intlBat" collection="intlBatList" open="("
				 close=")" separator=",">
				 #{intlBat}
		    </foreach>
		</if>
		<if test="pursOrdrIdList!= null and pursOrdrIdList.size() > 0">
			AND tgs.purs_ordr_id in
			<foreach item="pursOrdrId" collection="pursOrdrIdList" open="("
				 close=")" separator=",">
				 #{pursOrdrId}
		    </foreach>
		</if>
		<if test="memo != null and memo != ''">
            <bind name="memo" value="'%'+ memo +'%'"/>
            AND tgs.memo like #{memo}
        </if>
  	</where>
  </select>
  
  <!--   修改到货单处理状态 -->
  <update id="updateToGdsSnglDealStatOK" parameterType="String">
    update to_gds_sngl set deal_stat='已关闭' where to_gds_sngl_id = #{toGdsSnglId}
  </update>
  <!--   修改到货单处理状态 -->
  <update id="updateToGdsSnglDealStatNO" parameterType="String">
    update to_gds_sngl set deal_stat='已打开' where to_gds_sngl_id = #{toGdsSnglId}
  </update>
</mapper>